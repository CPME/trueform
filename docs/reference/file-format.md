# File Format (.tfp)

TrueFormâ€™s part file type is a `.tfp` container that stores the authoritative
IR plus optional preview artifacts (mesh + isometric thumbnail). The IR is the
source of truth. Preview artifacts are caches and can be regenerated.

## Container Layout

`.tfp` is a zip container with fixed top-level entries:

```
my_part.tfp
  manifest.json
  document.json
  artifacts/
    part.mesh.json
    preview.png
```

## document.json (Authoritative IR)

The document is the canonical, kernel-agnostic intent model.

```
{
  "schema": "trueform.document.v1",
  "document": {
    "id": "doc-1",
    "parts": [ /* IntentPart[] */ ],
    "assemblies": [],
    "capabilities": {},
    "constraints": [],
    "assertions": [],
    "context": {
      "units": "mm",
      "kernel": { "name": "ocjs", "version": "X.Y.Z" },
      "tolerance": { "linear": 1e-6, "angular": 1e-6 }
    }
  }
}
```

Notes:
- The IR stores no kernel history or B-Rep.
- Feature order in arrays is preserved.
- Assemblies are data-only in v1.

## manifest.json (Container Metadata)

The manifest declares schema versions, document hashes, and optional preview
artifacts.

```
{
  "schema": "trueform.container.v1",
  "createdAt": "2026-02-07T00:00:00Z",
  "document": {
    "path": "document.json",
    "schema": "trueform.document.v1",
    "hash": "sha256:...",
    "bytes": 12345
  },
  "artifacts": [
    {
      "type": "mesh",
      "path": "artifacts/part.mesh.json",
      "hash": "sha256:...",
      "bytes": 23456
    },
    {
      "type": "preview",
      "path": "artifacts/preview.png",
      "hash": "sha256:...",
      "bytes": 1024
    }
  ]
}
```

Notes:
- Hashes are SHA-256 over canonical JSON.
- Artifacts are optional and non-authoritative.
- `mesh` artifacts are intended for lightweight previews (low or medium
  resolution).
- `preview` artifacts are isometric thumbnails.
- Keep export-quality meshes and other artifacts as sidecar files
  (e.g. `*.mesh.json`, `*.iso.png`, `*.pmi.json`).

## Canonical JSON and Hashing

When hashing `document.json`:
- Object keys are sorted lexicographically.
- Array order is preserved.
- `undefined` values are omitted.

This ensures stable hashes for caching and diffing.

## File Handling

Open:
1. Unzip the `.tfp` container.
2. Parse `manifest.json` and `document.json`.
3. Validate schema versions.
4. Hash `document.json` and compare to manifest.
5. Load artifacts if present and hashes match.

Save:
1. Serialize the IR to `document.json`.
2. Compute document hash and update `manifest.json`.
3. Optionally include preview mesh + thumbnail artifacts and hashes.
4. Zip into a `.tfp` container.
5. Optionally regenerate sidecar artifacts.

## Minimal Example

The repository includes a minimal example container:
- `tools/tf/examples/minimal.tfp`

It is generated by:

```
node tools/tf/build_minimal_example.mjs
```

The implementation lives in:
- `src/tf/container.ts`
