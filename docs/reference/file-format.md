# File Format (.tfc)

TrueFormâ€™s native file type is a `.tfc` container that bundles the authoritative
IR with optional artifacts like meshes and thumbnails. The IR is the source of
truth. Artifacts are caches and can be regenerated.

## Container Layout

`.tfc` is a zip container with fixed top-level entries:

```
my_part.tfc
  manifest.json
  document.json
  artifacts/
    preview.png
    part.mesh.json
    part.step
    part.glb
    part.stl
    part.3mf
    part.dxf
    part.svg
    part.pmi.json
```

## document.json (Authoritative IR)

The document is the canonical, kernel-agnostic intent model.

```
{
  "schema": "trueform.document.v1",
  "document": {
    "id": "doc-1",
    "parts": [ /* IntentPart[] */ ],
    "assemblies": [],
    "capabilities": {},
    "constraints": [],
    "assertions": [],
    "context": {
      "units": "mm",
      "kernel": { "name": "ocjs", "version": "X.Y.Z" },
      "tolerance": { "linear": 1e-6, "angular": 1e-6 }
    }
  }
}
```

Notes:
- The IR stores no kernel history or B-Rep.
- Feature order in arrays is preserved.
- Assemblies are data-only in v1.

## manifest.json (Container Metadata)

The manifest declares schema versions, hashes, and artifacts.

```
{
  "schema": "trueform.container.v1",
  "createdAt": "2026-02-07T00:00:00Z",
  "document": {
    "path": "document.json",
    "schema": "trueform.document.v1",
    "hash": "sha256:...",
    "bytes": 12345
  },
  "artifacts": [
    {
      "type": "mesh",
      "path": "artifacts/part.mesh.json",
      "hash": "sha256:...",
      "bytes": 23456,
      "build": {
        "kernel": { "name": "ocjs", "version": "X.Y.Z" },
        "tolerance": { "linear": 1e-6, "angular": 1e-6 }
      }
    },
    {
      "type": "thumbnail",
      "path": "artifacts/preview.png",
      "hash": "sha256:...",
      "bytes": 1024
    }
  ]
}
```

Notes:
- Hashes are SHA-256 over canonical JSON or raw artifact bytes.
- Artifacts are optional and non-authoritative.
- PMI (AP242) is emitted as a JSON sidecar (`*.pmi.json`) in v1; embedding PMI entities into STEP is not implemented yet.

## Canonical JSON and Hashing

When hashing `document.json`:
- Object keys are sorted lexicographically.
- Array order is preserved.
- `undefined` values are omitted.

This ensures stable hashes for caching and diffing.

## File Handling

Open:
1. Unzip the `.tfc` container.
2. Parse `manifest.json` and `document.json`.
3. Validate schema versions.
4. Hash `document.json` and compare to manifest.
5. Load artifacts if present and hashes match.

Save:
1. Serialize the IR to `document.json`.
2. Compute document hash and update `manifest.json`.
3. Optionally regenerate artifacts and hashes.
4. Zip into a `.tfc` container.

## Minimal Example

The repository includes a minimal example container:
- `tools/tf/examples/minimal.tfc`

It is generated by:

```
node tools/tf/build_minimal_example.mjs
```

The implementation lives in:
- `src/tf/container.ts`
